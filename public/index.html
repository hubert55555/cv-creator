<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator CV z AI</title>
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .form-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="email"], input[type="tel"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .dynamic-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .add-btn, .remove-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .remove-btn {
            background-color: #dc3545;
        }
        .add-btn:hover, .remove-btn:hover {
            opacity: 0.8;
        }
        .section-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        .year-input {
            width: 100px;
            display: inline-block;
        }
        .submit-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
        }
        .submit-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Formularz CV</h1>
        
        <!-- Przycisk otwierania edytora -->
        <div style="margin-bottom: 20px; padding: 15px; background-color: #fff3cd; border-radius: 5px; border: 1px solid #ffc107;">
            <button type="button" onclick="openEmptyEditor()" style="padding: 12px 24px; background-color: #ffc107; color: #000; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%;">
                ‚úèÔ∏è Otw√≥rz edytor CV (bez generowania)
            </button>
            <p style="margin: 10px 0 0 0; font-size: 14px; color: #856404; text-align: center;">
                Otw√≥rz edytor CV, aby wczytaƒá i edytowaƒá zapisane wcze≈õniej CV z localStorage
            </p>
        </div>
        
        <!-- Sekcja ustawie≈Ñ generatora -->
        <div style="margin-bottom: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 5px; border: 1px solid #ddd;">
            <h2 class="section-title" style="margin-top: 0;">Ustawienia generatora</h2>
            <div class="form-group">
                <label for="theme-select" style="font-weight: bold; color: #555; margin-bottom: 10px; display: block;">Motyw CV:</label>
                <select id="theme-select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; margin-bottom: 20px;">
                    <option value="">≈Åadowanie...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="prompt-select" style="font-weight: bold; color: #555; margin-bottom: 10px; display: block;">Tryb generowania:</label>
                <select id="prompt-select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box;">
                    <option value="">≈Åadowanie...</option>
                </select>
            </div>
        </div>
        
        <!-- Sekcja importu/eksportu -->
        <div style="margin-bottom: 30px; padding: 20px; background-color: #e7f3ff; border-radius: 5px; border: 1px solid #007bff;">
            <h3 style="margin-top: 0; color: #333;">Zapisz/Wczytaj dane</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" onclick="downloadJSON()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">üíæ Zapisz formularz (JSON)</button>
                <label style="padding: 10px 20px; background-color: #28a745; color: white; border-radius: 5px; cursor: pointer; display: inline-block;">
                    üìÅ Wczytaj formularz (JSON)
                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadFromJSONFile(event)">
                </label>
            </div>
        </div>
        
        <form id="cvForm">
            <!-- Podstawowe dane -->
            <h2 class="section-title">Dane osobowe</h2>
            
            <div class="form-group">
                <label for="imie">Imiƒô:</label>
                <input type="text" id="imie" name="imie">
            </div>
            
            <div class="form-group">
                <label for="nazwisko">Nazwisko:</label>
                <input type="text" id="nazwisko" name="nazwisko">
            </div>
            
            <div class="form-group">
                <label for="telefon">Numer telefonu:</label>
                <input type="tel" id="telefon" name="telefon">
            </div>
            
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email">
            </div>
            
            <div class="form-group">
                <label for="adres">Adres:</label>
                <input type="text" id="adres" name="adres">
            </div>
            
            <!-- O mnie -->
            <h2 class="section-title">O mnie</h2>
            <div class="form-group">
                <label for="o-mnie">Kr√≥tko o mnie:</label>
                <textarea id="o-mnie" name="o-mnie" placeholder="Napisz kilka zda≈Ñ o sobie..."></textarea>
            </div>
            
            <!-- Edukacja -->
            <h2 class="section-title">Edukacja</h2>
            <div id="szkoly-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Nazwa szko≈Çy:</label>
                        <input type="text" name="szkola[]">
                    </div>
                    <div class="form-group">
                        <label>Lata nauki:</label>
                        <input type="text" name="lata-szkola[]" placeholder="np. 2018-2022">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addSchool()">+ Dodaj szko≈Çƒô</button>
            
            <!-- Umiejƒôtno≈õci -->
            <h2 class="section-title">Umiejƒôtno≈õci</h2>
            <div id="umiejetnosci-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Umiejƒôtno≈õƒá:</label>
                        <input type="text" name="umiejetnosc[]" placeholder="np. JavaScript, Photoshop">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addSkill()">+ Dodaj umiejƒôtno≈õƒá</button>
            
            <!-- Jƒôzyki -->
            <h2 class="section-title">Jƒôzyki</h2>
            <div id="jezyki-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Jƒôzyk:</label>
                        <input type="text" name="jezyk[]" placeholder="np. Angielski">
                    </div>
                    <div class="form-group">
                        <label>Poziom:</label>
                        <input type="text" name="poziom-jezyk[]" placeholder="np. B2, Native">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addLanguage()">+ Dodaj jƒôzyk</button>
            
            <!-- Do≈õwiadczenie zawodowe -->
            <h2 class="section-title">Do≈õwiadczenie zawodowe</h2>
            <div id="doswiadczenie-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Stanowisko:</label>
                        <input type="text" name="stanowisko[]">
                    </div>
                    <div class="form-group">
                        <label>Firma:</label>
                        <input type="text" name="firma[]">
                    </div>
                    <div class="form-group">
                        <label>Lata pracy:</label>
                        <input type="text" name="lata-praca[]" placeholder="np. 2020-2023">
                    </div>
                    <div class="form-group">
                        <label>Opis obowiƒÖzk√≥w:</label>
                        <textarea name="obowiazki[]" placeholder="Opisz co robi≈Çe≈õ w tej pracy..."></textarea>
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addExperience()">+ Dodaj do≈õwiadczenie</button>
            
            <!-- Referencje/Projekty -->
            <h2 class="section-title">Referencje / Projekty osobiste</h2>
            <div id="referencje-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Tytu≈Ç projektu/referencji:</label>
                        <input type="text" name="tytul-projektu[]">
                    </div>
                    <div class="form-group">
                        <label>Opis:</label>
                        <textarea name="opis-projektu[]" placeholder="Opisz projekt lub referencjƒô..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Link (opcjonalnie):</label>
                        <input type="text" name="link-projektu[]" placeholder="https://...">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addReference()">+ Dodaj referencjƒô/projekt</button>
            
            <button type="submit" class="submit-btn">Generuj CV</button>
        </form>
        
        
        <!-- Sekcja odpowiedzi AI -->
        <div id="ai-response" style="display: none; margin-top: 30px; padding: 20px; background-color: #f0f8ff; border-radius: 5px; border: 1px solid #007bff;">
            <h3>Wygenerowane CV:</h3>
            <div id="ai-response-content" style="background-color: #fff; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; border: 1px solid #ddd; min-height: 100px;">
                Przetwarzanie...
            </div>
            <div id="ai-response-actions" style="display: none; margin-top: 15px; gap: 10px; flex-wrap: wrap;">
                <button type="button" onclick="openGeneratedCV()" style="padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
                    üöÄ Otw√≥rz w nowej karcie
                </button>
            </div>
        </div>
    </div>

    <script>
        // Funkcje do dodawania dynamicznych sekcji
        function addSchool() {
            const container = document.getElementById('szkoly-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Nazwa szko≈Çy:</label>
                    <input type="text" name="szkola[]">
                </div>
                <div class="form-group">
                    <label>Lata nauki:</label>
                    <input type="text" name="lata-szkola[]" placeholder="np. 2018-2022">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addSkill() {
            const container = document.getElementById('umiejetnosci-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Umiejƒôtno≈õƒá:</label>
                    <input type="text" name="umiejetnosc[]" placeholder="np. JavaScript, Photoshop">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addLanguage() {
            const container = document.getElementById('jezyki-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Jƒôzyk:</label>
                    <input type="text" name="jezyk[]" placeholder="np. Angielski">
                </div>
                <div class="form-group">
                    <label>Poziom:</label>
                    <input type="text" name="poziom-jezyk[]" placeholder="np. B2, Native">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addExperience() {
            const container = document.getElementById('doswiadczenie-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Stanowisko:</label>
                    <input type="text" name="stanowisko[]">
                </div>
                <div class="form-group">
                    <label>Firma:</label>
                    <input type="text" name="firma[]">
                </div>
                <div class="form-group">
                    <label>Lata pracy:</label>
                    <input type="text" name="lata-praca[]" placeholder="np. 2020-2023">
                </div>
                <div class="form-group">
                    <label>Opis obowiƒÖzk√≥w:</label>
                    <textarea name="obowiazki[]" placeholder="Opisz co robi≈Çe≈õ w tej pracy..."></textarea>
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addReference() {
            const container = document.getElementById('referencje-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Tytu≈Ç projektu/referencji:</label>
                    <input type="text" name="tytul-projektu[]">
                </div>
                <div class="form-group">
                    <label>Opis:</label>
                    <textarea name="opis-projektu[]" placeholder="Opisz projekt lub referencjƒô..."></textarea>
                </div>
                <div class="form-group">
                    <label>Link (opcjonalnie):</label>
                    <input type="text" name="link-projektu[]" placeholder="https://...">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function removeSection(button) {
            button.parentElement.remove();
        }

        // Funkcja zbierajƒÖca dane w formacie JSON
        function collectFormData() {
            const formData = {
                daneOsobowe: {
                    imie: document.getElementById('imie').value,
                    nazwisko: document.getElementById('nazwisko').value,
                    telefon: document.getElementById('telefon').value,
                    email: document.getElementById('email').value,
                    adres: document.getElementById('adres').value
                },
                oMnie: document.getElementById('o-mnie').value,
                edukacja: [],
                umiejetnosci: [],
                jezyki: [],
                doswiadczenie: [],
                referencje: []
            };

            // Zbieranie danych z edukacji
            const szkoly = document.querySelectorAll('input[name="szkola[]"]');
            const lataSzkola = document.querySelectorAll('input[name="lata-szkola[]"]');
            for (let i = 0; i < szkoly.length; i++) {
                if (szkoly[i].value.trim() || lataSzkola[i].value.trim()) {
                    formData.edukacja.push({
                        szkola: szkoly[i].value,
                        lata: lataSzkola[i].value
                    });
                }
            }

            // Zbieranie umiejƒôtno≈õci
            const umiejetnosci = document.querySelectorAll('input[name="umiejetnosc[]"]');
            umiejetnosci.forEach(input => {
                if (input.value.trim()) {
                    formData.umiejetnosci.push(input.value);
                }
            });

            // Zbieranie jƒôzyk√≥w
            const jezyki = document.querySelectorAll('input[name="jezyk[]"]');
            const poziomy = document.querySelectorAll('input[name="poziom-jezyk[]"]');
            for (let i = 0; i < jezyki.length; i++) {
                if (jezyki[i].value.trim() || poziomy[i].value.trim()) {
                    formData.jezyki.push({
                        jezyk: jezyki[i].value,
                        poziom: poziomy[i].value
                    });
                }
            }

            // Zbieranie do≈õwiadczenia
            const stanowiska = document.querySelectorAll('input[name="stanowisko[]"]');
            const firmy = document.querySelectorAll('input[name="firma[]"]');
            const lataPraca = document.querySelectorAll('input[name="lata-praca[]"]');
            const obowiazki = document.querySelectorAll('textarea[name="obowiazki[]"]');
            for (let i = 0; i < stanowiska.length; i++) {
                if (stanowiska[i].value.trim() || firmy[i].value.trim() || lataPraca[i].value.trim()) {
                    formData.doswiadczenie.push({
                        stanowisko: stanowiska[i].value,
                        firma: firmy[i].value,
                        lata: lataPraca[i].value,
                        obowiazki: obowiazki[i].value
                    });
                }
            }

            // Zbieranie referencji/projekt√≥w
            const tytuly = document.querySelectorAll('input[name="tytul-projektu[]"]');
            const opisy = document.querySelectorAll('textarea[name="opis-projektu[]"]');
            const linki = document.querySelectorAll('input[name="link-projektu[]"]');
            for (let i = 0; i < tytuly.length; i++) {
                if (tytuly[i].value.trim() || opisy[i].value.trim()) {
                    formData.referencje.push({
                        tytul: tytuly[i].value,
                        opis: opisy[i].value,
                        link: linki[i].value
                    });
                }
            }

            return formData;
        }

        // Obs≈Çuga formularza
        document.getElementById('cvForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Zbieranie danych w formacie JSON
            const cvData = collectFormData();
            
            // Wy≈õwietlenie danych w konsoli (do debugowania)
            console.log('Dane CV w formacie JSON:', cvData);
            
            // Przekazanie danych do zmiennej globalnej
            window.cvData = cvData;
            
            // Automatyczne wys≈Çanie danych do AI
            sendToAI(cvData);
        });

        // Funkcja inicjalizacji selektora motyw√≥w
        function initThemeSelector() {
            const select = document.getElementById('theme-select');
            if (!select) {
                // Spr√≥buj ponownie za chwilƒô, je≈õli element jeszcze nie istnieje
                setTimeout(initThemeSelector, 100);
                return;
            }

            const templates = window.config?.templates;
            
            // Je≈õli config jeszcze nie jest za≈Çadowany, spr√≥buj ponownie
            if (!window.config || !templates) {
                setTimeout(initThemeSelector, 100);
                return;
            }

            // Wyczyszczenie opcji
            select.innerHTML = '';

            if (templates && typeof templates === 'object') {
                // Mapowanie kluczy motyw√≥w na czytelne nazwy
                const themeLabels = {
                    modernBlue: 'Modern Blue',
                    classic: 'Classic'
                };
                
                // Dodaj opcje z config.templates
                Object.keys(templates).forEach((key) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = themeLabels[key] || key;
                    select.appendChild(opt);
                });
                // Domy≈õlnie wybierz 'modernBlue' je≈õli istnieje
                if (templates.modernBlue) {
                    select.value = 'modernBlue';
                }
            } else {
                // Fallback
                const opt = document.createElement('option');
                opt.value = 'modernBlue';
                opt.textContent = 'Modern Blue';
                select.appendChild(opt);
            }
        }

        // Funkcja inicjalizacji selektora prompt√≥w
        function initPromptSelector() {
            const select = document.getElementById('prompt-select');
            if (!select) {
                // Spr√≥buj ponownie za chwilƒô, je≈õli element jeszcze nie istnieje
                setTimeout(initPromptSelector, 100);
                return;
            }

            const prompts = window.config?.prompts;
            
            // Je≈õli config jeszcze nie jest za≈Çadowany, spr√≥buj ponownie
            if (!window.config || !prompts) {
                setTimeout(initPromptSelector, 100);
                return;
            }

            // Wyczyszczenie opcji
            select.innerHTML = '';

            if (prompts && typeof prompts === 'object') {
                // Dodaj opcje z config.prompts
                Object.keys(prompts).forEach((key) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = prompts[key]?.label || key;
                    select.appendChild(opt);
                });
                // Domy≈õlnie wybierz 'verbose' je≈õli istnieje, w innym razie pierwszƒÖ opcjƒô
                if (prompts.verbose) {
                    select.value = 'verbose';
                }
            } else {
                // Fallback do pojedynczego cvPrompt
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Domy≈õlny prompt';
                select.appendChild(opt);
            }
        }

        // Uruchom inicjalizacjƒô po za≈Çadowaniu DOM i config.js
        function initializeSelectors() {
            let attempts = 0;
            const maxAttempts = 50; // Maksymalnie 5 sekund (50 * 100ms)
            
            function tryInit() {
                attempts++;
                if (window.config && window.config.templates && window.config.prompts) {
                    // Config jest gotowy
                    initThemeSelector();
                    initPromptSelector();
                } else if (attempts < maxAttempts) {
                    // Spr√≥buj ponownie za 100ms
                    setTimeout(tryInit, 100);
                } else {
                    // Po max pr√≥bach, u≈ºyj fallback
                    console.warn('Config.js nie zosta≈Ç za≈Çadowany w oczekiwanym czasie. U≈ºywam fallback.');
                    const themeSelect = document.getElementById('theme-select');
                    const promptSelect = document.getElementById('prompt-select');
                    if (themeSelect) {
                        themeSelect.innerHTML = '<option value="modernBlue">Modern Blue</option>';
                    }
                    if (promptSelect) {
                        promptSelect.innerHTML = '<option value="verbose">Kreatywne rozwiniƒôcie</option>';
                    }
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', tryInit);
            } else {
                tryInit();
            }
        }
        
        // Uruchom inicjalizacjƒô
        initializeSelectors();

        // Funkcja pobierania JSON jako plik
        function downloadJSON() {
            const cvData = collectFormData();
            const jsonText = JSON.stringify(cvData, null, 2);
            const blob = new Blob([jsonText], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cv_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Funkcja kopiowania JSON do schowka
        function copyToClipboard() {
            const cvData = collectFormData();
            const jsonText = JSON.stringify(cvData, null, 2);
            navigator.clipboard.writeText(jsonText).then(function() {
                alert('JSON zosta≈Ç skopiowany do schowka!');
            }).catch(function(err) {
                console.error('B≈ÇƒÖd kopiowania: ', err);
                // Fallback dla starszych przeglƒÖdarek
                const textArea = document.createElement('textarea');
                textArea.value = jsonText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('JSON zosta≈Ç skopiowany do schowka!');
            });
        }

        // Funkcja wczytujƒÖca dane z pliku JSON i wype≈ÇniajƒÖca formularz
        function loadFromJSONFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    populateFormFromJSON(jsonData);
                    
                    // Wyczy≈õƒá input, ≈ºeby mo≈ºna by≈Ço wczytaƒá ten sam plik ponownie
                    event.target.value = '';
                } catch (error) {
                    alert('B≈ÇƒÖd: Nieprawid≈Çowy format JSON. ' + error.message);
                    console.error('B≈ÇƒÖd parsowania JSON:', error);
                }
            };
            reader.onerror = function() {
                alert('B≈ÇƒÖd podczas odczytu pliku.');
            };
            reader.readAsText(file);
        }

        // Funkcja wype≈ÇniajƒÖca formularz danymi z JSON
        function populateFormFromJSON(data) {
            // Wype≈Çnij dane osobowe
            if (data.daneOsobowe) {
                if (data.daneOsobowe.imie) document.getElementById('imie').value = data.daneOsobowe.imie;
                if (data.daneOsobowe.nazwisko) document.getElementById('nazwisko').value = data.daneOsobowe.nazwisko;
                if (data.daneOsobowe.telefon) document.getElementById('telefon').value = data.daneOsobowe.telefon;
                if (data.daneOsobowe.email) document.getElementById('email').value = data.daneOsobowe.email;
                if (data.daneOsobowe.adres) document.getElementById('adres').value = data.daneOsobowe.adres;
            }

            // Wype≈Çnij "O mnie"
            if (data.oMnie) document.getElementById('o-mnie').value = data.oMnie;

            // Wype≈Çnij edukacjƒô
            if (data.edukacja && Array.isArray(data.edukacja) && data.edukacja.length > 0) {
                clearContainer('szkoly-container');
                data.edukacja.forEach((ed, index) => {
                    if (index > 0) addSchool();
                    const sections = document.querySelectorAll('#szkoly-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    if (inputs[0]) inputs[0].value = ed.szkola || '';
                    if (inputs[1]) inputs[1].value = ed.lata || '';
                });
            }

            // Wype≈Çnij umiejƒôtno≈õci
            if (data.umiejetnosci && Array.isArray(data.umiejetnosci) && data.umiejetnosci.length > 0) {
                clearContainer('umiejetnosci-container');
                data.umiejetnosci.forEach((skill, index) => {
                    if (index > 0) addSkill();
                    const sections = document.querySelectorAll('#umiejetnosci-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    if (inputs[0]) inputs[0].value = skill || '';
                });
            }

            // Wype≈Çnij jƒôzyki
            if (data.jezyki && Array.isArray(data.jezyki) && data.jezyki.length > 0) {
                clearContainer('jezyki-container');
                data.jezyki.forEach((lang, index) => {
                    if (index > 0) addLanguage();
                    const sections = document.querySelectorAll('#jezyki-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    if (inputs[0]) inputs[0].value = lang.jezyk || '';
                    if (inputs[1]) inputs[1].value = lang.poziom || '';
                });
            }

            // Wype≈Çnij do≈õwiadczenie
            if (data.doswiadczenie && Array.isArray(data.doswiadczenie) && data.doswiadczenie.length > 0) {
                clearContainer('doswiadczenie-container');
                data.doswiadczenie.forEach((exp, index) => {
                    if (index > 0) addExperience();
                    const sections = document.querySelectorAll('#doswiadczenie-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    const textareas = sections[index].querySelectorAll('textarea');
                    if (inputs[0]) inputs[0].value = exp.stanowisko || '';
                    if (inputs[1]) inputs[1].value = exp.firma || '';
                    if (inputs[2]) inputs[2].value = exp.lata || '';
                    if (textareas[0]) textareas[0].value = exp.obowiazki || '';
                });
            }

            // Wype≈Çnij referencje/projekty
            if (data.referencje && Array.isArray(data.referencje) && data.referencje.length > 0) {
                clearContainer('referencje-container');
                data.referencje.forEach((ref, index) => {
                    if (index > 0) addReference();
                    const sections = document.querySelectorAll('#referencje-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    const textareas = sections[index].querySelectorAll('textarea');
                    if (inputs[0]) inputs[0].value = ref.tytul || '';
                    if (textareas[0]) textareas[0].value = ref.opis || '';
                    if (inputs[1]) inputs[1].value = ref.link || '';
                });
            }
        }

        // Zmienna globalna do przechowywania wygenerowanego HTML
        let generatedCVHtml = null;
        let generatedCVBlobUrl = null;

        // Zawarto≈õƒá plik√≥w CSS i JS (do wbudowania w HTML) - cv-scaling.css jako fallback
        const cvScalingCssFallback = `/* Wsp√≥lne style skalowania CV dla wszystkich motyw√≥w */
/* Ten plik zawiera regu≈Çy odpowiedzialne za automatyczne dopasowanie CV do jednej strony A4 */
/* Nale≈ºy za≈Çadowaƒá ten plik PRZED plikiem CSS motywu (style.css lub style1.css) */

:root {
  /* Skalowanie zawarto≈õci (ustawiane przez cv-auto-fit.js) */
  --content-scale: 1;
}

/* Pojedyncza strona A4 - ustawienia skalowania */
/* Uwaga: --page-height jest definiowane w pliku CSS motywu (style.css/style1.css) */
.page {
  height: var(--page-height, 297mm); /* Fallback do 297mm je≈õli zmienna nie jest zdefiniowana */
  overflow: hidden; /* Ukryj wszystko co wychodzi poza stronƒô */
  position: relative;
}

/* Struktura zawarto≈õci CV - przygotowanie do skalowania */
.cv-columns {
  transform-origin: top left; /* Dla skalowania z cv-auto-fit.js */
}

/* Ustawienia druku z zachowaniem skalowania */
@media print {
  .page {
    height: var(--page-height, 297mm) !important; /* Dok≈Çadna wysoko≈õƒá A4 */
    overflow: hidden !important; /* Ukryj wszystko co wychodzi poza stronƒô przy druku */
  }
  /* Transform scale dzia≈Ça przy druku, wiƒôc skalowanie bƒôdzie dzia≈Çaƒá */
}
`;

        // Funkcja wbudowujƒÖca CSS i JS bezpo≈õrednio w HTML
        async function embedAssetsInHtml(htmlString) {
            let processedHtml = htmlString;
            
            // Pobierz zawarto≈õƒá plik√≥w CSS i JS u≈ºywajƒÖc fetch (tylko je≈õli jeste≈õmy na lokalnym serwerze)
            // Je≈õli to nie zadzia≈Ça, u≈ºyj hardcoded zawarto≈õci
            const assets = {
                'cv-scaling.css': cvScalingCssFallback,
                'cv-auto-fit.js': '', // Bƒôdzie wczytane poni≈ºej
                'cv-inline-edit.js': '', // Bƒôdzie wczytane poni≈ºej
            };

            // Spr√≥buj wczytaƒá pliki CSS z serwera (je≈õli sƒÖ dostƒôpne)
            try {
                const cvScalingResponse = await fetch('cv-scaling.css');
                if (cvScalingResponse.ok) {
                    assets['cv-scaling.css'] = await cvScalingResponse.text();
                }
            } catch (e) {
                // U≈ºyj hardcoded zawarto≈õci
            }

            try {
                const style1Response = await fetch('style1.css');
                if (style1Response.ok) {
                    assets['style1.css'] = await style1Response.text();
                }
            } catch (e) {
                // U≈ºyj pustej zawarto≈õci
            }

            try {
                const styleResponse = await fetch('style.css');
                if (styleResponse.ok) {
                    assets['style.css'] = await styleResponse.text();
                }
            } catch (e) {
                // U≈ºyj pustej zawarto≈õci
            }

            try {
                const autoFitResponse = await fetch('cv-auto-fit.js');
                if (autoFitResponse.ok) {
                    assets['cv-auto-fit.js'] = await autoFitResponse.text();
                }
            } catch (e) {
                // U≈ºyj hardcoded zawarto≈õci poni≈ºej
            }

            try {
                const inlineEditResponse = await fetch('cv-inline-edit.js');
                if (inlineEditResponse.ok) {
                    assets['cv-inline-edit.js'] = await inlineEditResponse.text();
                }
            } catch (e) {
                // U≈ºyj hardcoded zawarto≈õci poni≈ºej
            }

            // Je≈õli pliki nie zosta≈Çy wczytane, u≈ºyj hardcoded zawarto≈õci
            if (!assets['cv-auto-fit.js']) {
                assets['cv-auto-fit.js'] = `/* cv-auto-fit.js content - zobacz plik cv-auto-fit.js dla pe≈Çnej zawarto≈õci */
(function() {
  'use strict';
  function fitToPage() {
    const page = document.querySelector('.page');
    const cvColumns = document.querySelector('.cv-columns');
    const root = document.documentElement;
    if (!page || !cvColumns) {
      if (document.readyState === 'loading') {
        setTimeout(fitToPage, 100);
      }
      return;
    }
    function mmToPx(mm) {
      return mm * 3.779527559;
    }
    const pageHeight = 297;
    const marginTop = 12;
    const marginBottom = 15;
    const availableHeight = pageHeight - marginTop - marginBottom;
    function checkAndScale() {
      root.style.setProperty('--content-scale', '1');
      cvColumns.style.transform = '';
      const addButtons = page.querySelectorAll('.cv-add-btn, .cv-delete-btn, .cv-delete-section-btn');
      const addButtonsData = [];
      addButtons.forEach((btn) => {
        const hasDisplay = btn.style.display !== '';
        addButtonsData.push({
          element: btn,
          originalDisplay: hasDisplay ? btn.style.display : null
        });
        btn.style.display = 'none';
      });
      void cvColumns.offsetHeight;
      setTimeout(() => {
        const contentHeight = cvColumns.scrollHeight;
        const contentWidth = cvColumns.scrollWidth;
        const availableHeightPx = mmToPx(availableHeight);
        const pageWidthPx = mmToPx(210);
        const marginSidesPx = mmToPx(12) * 2;
        const maxWidthPx = pageWidthPx - marginSidesPx;
        const heightScale = contentHeight > availableHeightPx 
          ? (availableHeightPx / contentHeight) * 0.98
          : 1;
        const widthScale = contentWidth > maxWidthPx
          ? (maxWidthPx / contentWidth) * 0.98
          : 1;
        let finalScale = Math.min(heightScale, widthScale);
        finalScale = Math.max(finalScale, 0.5);
        if (finalScale < 1) {
          root.style.setProperty('--content-scale', finalScale);
          cvColumns.style.transform = 'scale(' + finalScale + ')';
          cvColumns.style.transformOrigin = 'top left';
        } else {
          root.style.setProperty('--content-scale', '1');
          cvColumns.style.transform = '';
        }
        addButtonsData.forEach(item => {
          if (item.originalDisplay !== null) {
            item.element.style.display = item.originalDisplay;
          } else {
            item.element.style.display = '';
          }
        });
      }, 10);
    }
    const images = page.querySelectorAll('img');
    let imagesLoaded = 0;
    const totalImages = images.length;
    if (totalImages > 0) {
      images.forEach(img => {
        if (img.complete) {
          imagesLoaded++;
        } else {
          img.onload = function() {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
              setTimeout(checkAndScale, 150);
            }
          };
          img.onerror = function() {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
              setTimeout(checkAndScale, 150);
            }
          };
        }
      });
      if (imagesLoaded === totalImages) {
        setTimeout(checkAndScale, 150);
      }
    } else {
      setTimeout(checkAndScale, 150);
    }
    if (document.readyState === 'complete') {
      setTimeout(checkAndScale, 500);
    } else {
      window.addEventListener('load', function() {
        setTimeout(checkAndScale, 500);
      });
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fitToPage);
  } else {
    fitToPage();
  }
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(fitToPage, 200);
  });
  window.cvFitToPage = fitToPage;
})();`;
            }

            if (!assets['cv-inline-edit.js']) {
                // Uwaga: Ze wzglƒôdu na d≈Çugo≈õƒá pe≈Çnej zawarto≈õci cv-inline-edit.js (1300+ linii),
                // najlepiej wczytaƒá jƒÖ przez fetch je≈õli pliki sƒÖ dostƒôpne lokalnie.
                // Je≈õli fetch nie zadzia≈Ça, u≈ºyj uproszczonej wersji z podstawowƒÖ funkcjonalno≈õciƒÖ zapisywania stanu.
                console.warn('cv-inline-edit.js nie zosta≈Ç wczytany z serwera. U≈ºywam uproszczonej wersji.');
                assets['cv-inline-edit.js'] = `/* Uproszczona wersja cv-inline-edit.js z podstawowƒÖ funkcjonalno≈õciƒÖ zapisywania stanu */
(function() {
  'use strict';
  let hasUnsavedChanges = false;
  
  // Funkcje zapisywania stanu
  function getSavedStates() {
    try {
      const savesStr = localStorage.getItem('cv-saves-list');
      return savesStr ? JSON.parse(savesStr) : {};
    } catch (e) { return {}; }
  }
  
  function saveCVState(saveName) {
    try {
      const htmlContent = document.documentElement.outerHTML;
      const timestamp = new Date().toISOString();
      const saveKey = saveName ? 'cv-state-' + saveName.replace(/[^a-zA-Z0-9]/g, '-') : 'cv-state-' + timestamp;
      
      if (!saveName) {
        const dateStr = new Date().toLocaleString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        saveName = 'Zapis z ' + dateStr;
      }
      
      const stateData = { html: htmlContent, timestamp: timestamp, name: saveName, key: saveKey };
      localStorage.setItem(saveKey, JSON.stringify(stateData));
      
      const saves = getSavedStates();
      saves[saveKey] = { timestamp: timestamp, name: saveName };
      localStorage.setItem('cv-saves-list', JSON.stringify(saves));
      localStorage.setItem('cv-last-save', saveKey);
      
      showSaveIndicator('‚úì Stan zapisany: "' + saveName + '"');
      if (window.cvUpdateSavesPanel) window.cvUpdateSavesPanel();
      return true;
    } catch (e) {
      alert('Nie mo≈ºna zapisaƒá stanu: ' + e.message);
      return false;
    }
  }
  
  function restoreCVState(saveKey) {
    try {
      const stateDataStr = localStorage.getItem(saveKey);
      if (!stateDataStr) { alert('Nie znaleziono zapisanego stanu.'); return false; }
      const stateData = JSON.parse(stateDataStr);
      if (confirm('Czy na pewno chcesz przywr√≥ciƒá stan "' + stateData.name + '"? Obecne zmiany zostanƒÖ utracone.')) {
        document.open();
        document.write(stateData.html);
        document.close();
        
        // Funkcja pr√≥bujƒÖca zainicjalizowaƒá z wieloma pr√≥bami
        function tryInitWithRetry(attempt, maxAttempts) {
          attempt = attempt || 0;
          maxAttempts = maxAttempts || 10;
          
          // Reset flagi aby umo≈ºliwiƒá ponownƒÖ inicjalizacjƒô
          window.__cvInitCalled = false;
          if (document.body) {
            document.body.removeAttribute('data-cv-initialized');
          }
          
          // Sprawd≈∫ czy funkcje sƒÖ dostƒôpne
          var hasCvInit = window.cvInit && typeof window.cvInit === 'function';
          var hasAddButtons = typeof addButtons === 'function';
          
          if (hasCvInit) {
            try {
              window.cvInit();
              showSaveIndicator('‚úì Przywr√≥cono stan: "' + stateData.name + '"');
              return;
            } catch (e) {
              console.error('B≈ÇƒÖd cvInit:', e);
            }
          }
          
          // Je≈õli cvInit nie dzia≈Ça, spr√≥buj dodaƒá przyciski bezpo≈õrednio
          if (hasAddButtons) {
            try {
              addButtons();
              showSaveIndicator('‚úì Przywr√≥cono stan: "' + stateData.name + '"');
              return;
            } catch (e) {
              console.error('B≈ÇƒÖd addButtons:', e);
            }
          }
          
          // Je≈õli nie uda≈Ço siƒô i sƒÖ jeszcze pr√≥by, spr√≥buj ponownie
          if (attempt < maxAttempts) {
            setTimeout(function() { tryInitWithRetry(attempt + 1, maxAttempts); }, 200);
          } else {
            console.error('Nie uda≈Ço siƒô zainicjalizowaƒá po przywr√≥ceniu stanu');
            showSaveIndicator('‚úì Przywr√≥cono stan: "' + stateData.name + '"');
          }
        }
        
        // Rozpocznij pr√≥by inicjalizacji
        setTimeout(function() { tryInitWithRetry(); }, 300);
        return true;
      }
      return false;
    } catch (e) {
      alert('Nie mo≈ºna przywr√≥ciƒá stanu: ' + e.message);
      return false;
    }
  }
  
  function deleteCVState(saveKey) {
    try {
      const saves = getSavedStates();
      delete saves[saveKey];
      localStorage.removeItem(saveKey);
      localStorage.setItem('cv-saves-list', JSON.stringify(saves));
      const lastSave = localStorage.getItem('cv-last-save');
      if (lastSave === saveKey) localStorage.removeItem('cv-last-save');
      if (window.cvUpdateSavesPanel) window.cvUpdateSavesPanel();
      showSaveIndicator('‚úì Stan zosta≈Ç usuniƒôty');
      return true;
    } catch (e) { return false; }
  }
  
  function showSaveIndicator(msg) {
    const ind = document.createElement('div');
    ind.className = 'save-indicator';
    ind.textContent = msg || '‚úì Zmiany zapisane lokalnie';
    ind.style.cssText = 'position:fixed;bottom:80px;right:20px;background:#28a745;color:white;padding:10px 16px;border-radius:6px;box-shadow:0 4px 12px rgba(40,167,69,0.3);z-index:1000;font-size:13px;animation:slideUp 0.3s ease;';
    document.body.appendChild(ind);
    setTimeout(() => { ind.style.opacity='0'; ind.style.transition='opacity 0.3s'; setTimeout(() => ind.remove(), 300); }, 3000);
  }
  
  // Dodaj przyciski
  function addButtons() {
    if (document.getElementById('cv-download-btn')) return;
    const btn = document.createElement('button');
    btn.id = 'cv-download-btn';
    btn.className = 'cv-download-button';
    btn.innerHTML = 'üíæ Zapisz stan CV';
    btn.title = 'Zapisz aktualny stan CV w przeglƒÖdarce';
    btn.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:12px 20px;background:#007bff;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;box-shadow:0 4px 12px rgba(0,123,255,0.3);z-index:1000;display:none;';
    btn.onclick = () => {
      const name = prompt('Wprowad≈∫ nazwƒô dla tego zapisu (lub zostaw puste dla automatycznej):', '');
      saveCVState(name || null);
    };
    document.body.appendChild(btn);
    
    const mgrBtn = document.createElement('button');
    mgrBtn.id = 'cv-saves-manager-btn';
    mgrBtn.innerHTML = 'üìö Moje zapisy';
    mgrBtn.style.cssText = 'position:fixed;bottom:20px;right:180px;padding:12px 20px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;z-index:1000;';
    mgrBtn.onclick = () => {
      const saves = getSavedStates();
      const keys = Object.keys(saves).sort((a,b) => saves[b].timestamp.localeCompare(saves[a].timestamp));
      if (keys.length === 0) {
        alert('Brak zapisanych stan√≥w.');
        return;
      }
      let msg = 'Zapisane stany CV:\\n\\n';
      keys.forEach((key, i) => {
        const save = saves[key];
        const date = new Date(save.timestamp).toLocaleString('pl-PL');
        msg += (i+1) + '. ' + save.name + ' (' + date + ')\\n';
      });
      msg += '\\nWpisz numer stanu do przywr√≥cenia (lub 0 aby anulowaƒá):';
      const choice = prompt(msg);
      if (choice && choice !== '0' && keys[parseInt(choice)-1]) {
        restoreCVState(keys[parseInt(choice)-1]);
      }
    };
    document.body.appendChild(mgrBtn);
  }
  
  // Podstawowa funkcjonalno≈õƒá edycji inline
  document.addEventListener('dblclick', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON') return;
    if (e.target.closest('button') || e.target.closest('script') || e.target.closest('style')) return;
    
    const element = e.target;
    if (element.contentEditable !== 'true' && element.textContent.trim()) {
      element.contentEditable = 'true';
      element.style.outline = '2px solid #007bff';
      element.style.outlineOffset = '2px';
      element.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
      
      const range = document.createRange();
      range.selectNodeContents(element);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      element.focus();
      
      function finishEdit() {
        element.contentEditable = 'false';
        element.style.outline = '';
        element.style.backgroundColor = '';
        hasUnsavedChanges = true;
        const btn = document.getElementById('cv-download-btn');
        if (btn) {
          btn.style.display = 'block';
          // Przesu≈Ñ przycisk zarzƒÖdzania zapisami, ≈ºeby siƒô nie nak≈Çada≈Çy
          const savesButton = document.getElementById('cv-saves-manager-btn');
          if (savesButton) {
            savesButton.style.right = '200px';
          }
        }
        try {
          localStorage.setItem('cv-edited-content', document.documentElement.outerHTML);
        } catch (e) {}
      }
      
      element.addEventListener('blur', finishEdit, { once: true });
      element.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter' && !ev.shiftKey) {
          ev.preventDefault();
          finishEdit();
        }
        if (ev.key === 'Escape') {
          ev.preventDefault();
          element.textContent = element.dataset.originalText || element.textContent;
          finishEdit();
        }
      });
      
      if (!element.dataset.originalText) {
        element.dataset.originalText = element.textContent;
      }
    }
  });
  
  window.cvRestoreState = restoreCVState;
  window.cvDeleteState = deleteCVState;
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addButtons);
  } else {
    addButtons();
  }
  
  // Komunikat pytajƒÖcy o przywr√≥cenie zapisanego stanu zosta≈Ç usuniƒôty
  // U≈ºytkownik mo≈ºe rƒôcznie przywr√≥ciƒá stan przez przycisk "Moje zapisy"
})();`;
            }

            // Zamie≈Ñ linki do CSS na inline style
            const linkCssRegex = /<link\s+rel="stylesheet"\s+href="([^"]+\.css)"\s*\/?>/gi;
            processedHtml = processedHtml.replace(
                linkCssRegex,
                (match, href) => {
                    const filename = href.split('/').pop();
                    if (assets[filename]) {
                        // Escape specjalnych znak√≥w w CSS
                        const escapedCss = assets[filename].replace(/<\/style>/gi, '<\\/style>');
                        return '<style>' + escapedCss + '</style>';
                    }
                    return match; // Je≈õli plik nie zosta≈Ç znaleziony, pozostaw oryginalny link
                }
            );

            // Zamie≈Ñ skrypty JS na inline script
            // U≈ºyj split aby uniknƒÖƒá ko≈Ñca tagu script w kodzie ≈∫r√≥d≈Çowym HTML
            const scriptOpen = '<' + 'script';
            const scriptClose = '<' + '/' + 'script' + '>';
            const scriptEndRegexPattern = '<' + '\\/' + 'script' + '>';
            const scriptEndRegex = new RegExp(scriptEndRegexPattern, 'gi');
            
            // Buduj regex pattern dla script src
            const scriptSrcPattern = scriptOpen + '\\s+src="([^"]+\\.js)"\\s*' + '>' + scriptClose;
            const scriptSrcRegex = new RegExp(scriptSrcPattern, 'gi');
            
            processedHtml = processedHtml.replace(scriptSrcRegex, function(match, src) {
                const filename = src.split('/').pop();
                if (assets[filename]) {
                    // Escape specjalnych znak√≥w w JS
                    const escapedJs = assets[filename].replace(scriptEndRegex, '<\\/script>');
                    return scriptOpen + '>' + escapedJs + scriptClose;
                }
                return match;
            });

            return processedHtml;
        }

        // Funkcja otwierajƒÖca pusty edytor CV (bez generowania)
        async function openEmptyEditor() {
            // Spr√≥buj wczytaƒá szablon z template1.html, je≈õli siƒô nie uda, u≈ºyj pustego szablonu
            let emptyCVTemplate = '';
            
            try {
                const response = await fetch('template1.html');
                if (response.ok) {
                    emptyCVTemplate = await response.text();
                    // Dodaj linki do skrypt√≥w edycji je≈õli ich nie ma
                    if (!emptyCVTemplate.includes('cv-auto-fit.js')) {
                        // Dodaj przed </body>
                        const scriptsToAdd = '<link rel="stylesheet" href="cv-scaling.css" />' +
                            '<script src="cv-auto-fit.js"><' + '/script>' +
                            '<script src="cv-inline-edit.js"><' + '/script>';
                        emptyCVTemplate = emptyCVTemplate.replace('</body>', scriptsToAdd + '</body>');
                    }
                } else {
                    throw new Error('Nie mo≈ºna wczytaƒá szablonu');
                }
            } catch (e) {
                // Fallback - u≈ºyj podstawowego szablonu CV z minimalnƒÖ strukturƒÖ
                const parts = [
                    '<!doctype html><html lang="pl"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />',
                    '<title>CV ‚Äì Edytor</title><link rel="stylesheet" href="style.css" /><link rel="stylesheet" href="cv-scaling.css" /></head>',
                    '<body><section class="page"><div class="cv-columns"><aside class="cv-sidebar">',
                    '<div class="avatar"><img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=400&auto=format&fit=crop" alt="Zdjƒôcie profilowe" /></div>',
                    '<section class="side-section"><h3 class="side-title">Contact</h3><div class="side-list"><div>Telefon</div><div>Email</div><div>Adres</div></div></section>',
                    '<section class="side-section"><h3 class="side-title">Education</h3><div class="side-list"><div><strong>Lata</strong><br />Nazwa szko≈Çy<br />Kierunek</div></div></section>',
                    '<section class="side-section"><h3 class="side-title">Skills</h3><div class="side-list"><div>Umiejƒôtno≈õƒá 1</div><div>Umiejƒôtno≈õƒá 2</div></div></section>',
                    '<section class="side-section"><h3 class="side-title">Languages</h3><div class="side-list"><div>Jƒôzyk (Poziom)</div></div></section></aside>',
                    '<main class="cv-main"><header class="name-title"><h1><span class="light">IMIƒò</span> NAZWISKO</h1>',
                    '<div class="role">STANOWISKO</div><div class="underline"></div></header>',
                    '<section class="section"><div class="title">Profile</div><div class="rule"></div><p class="text">Opis profilu zawodowego...</p></section>',
                    '<section class="section"><div class="title">Work Experience</div><div class="rule"></div>',
                    '<div class="timeline"><article class="timeline-item"><div class="meta"><div><strong>Nazwa firmy</strong><br />Stanowisko</div><div>Lata</div></div>',
                    '<ul><li>Opis obowiƒÖzk√≥w 1</li><li>Opis obowiƒÖzk√≥w 2</li></ul></article></div></section>',
                    '<section class="section"><div class="title">Reference</div><div class="rule"></div>',
                    '<div class="references"><div class="ref-card"><div class="name">Nazwa projektu</div><div class="small">Opis projektu</div></div></div></section>',
                    '</main></div></section>' +
                    '<script src="cv-auto-fit.js"><' + '/script>' +
                    '<script src="cv-inline-edit.js"><' + '/script>' +
                    '</body></html>'
                ];
                emptyCVTemplate = parts.join('');
            }
            
            // Wbuduj CSS i JS w HTML przed utworzeniem blob URL
            const htmlWithAssets = await embedAssetsInHtml(emptyCVTemplate);
            
            // Utw√≥rz blob URL z HTML zawierajƒÖcym wbudowane zasoby
            const blob = new Blob([htmlWithAssets], { type: 'text/html;charset=utf-8' });
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        }

        // Funkcja otwierajƒÖca wygenerowane CV w nowej karcie
        async function openGeneratedCV() {
            if (!generatedCVHtml) {
                alert('Brak wygenerowanego CV. Najpierw wygeneruj CV.');
                return;
            }
            
            // Wbuduj CSS i JS w HTML przed utworzeniem blob URL
            const htmlWithAssets = await embedAssetsInHtml(generatedCVHtml);
            
            // Zwolnij poprzedni blob URL je≈õli istnieje
            if (generatedCVBlobUrl) {
                URL.revokeObjectURL(generatedCVBlobUrl);
            }
            
            // Utw√≥rz nowy blob URL z HTML zawierajƒÖcym wbudowane zasoby
            const blob = new Blob([htmlWithAssets], { type: 'text/html;charset=utf-8' });
            generatedCVBlobUrl = URL.createObjectURL(blob);
            window.open(generatedCVBlobUrl, '_blank');
        }

        // Funkcja zapisywania pliku HTML z mo≈ºliwo≈õciƒÖ wyboru nazwy i lokalizacji (u≈ºywana wewnƒôtrznie)
        async function saveHtmlFile(htmlContent, defaultFileName = 'cv.html') {
            // Zapytaj u≈ºytkownika o nazwƒô pliku
            const fileName = prompt('Wprowad≈∫ nazwƒô pliku:', defaultFileName.replace('.html', ''));
            
            if (!fileName) {
                // U≈ºytkownik anulowa≈Ç
                return false;
            }
            
            // Upewnij siƒô, ≈ºe plik ma rozszerzenie .html
            const finalFileName = fileName.endsWith('.html') ? fileName : fileName + '.html';
            
            // Pr√≥ba u≈ºycia File System Access API (daje mo≈ºliwo≈õƒá wyboru lokalizacji)
            if ('showSaveFilePicker' in window) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: finalFileName,
                        types: [{
                            description: 'HTML files',
                            accept: {
                                'text/html': ['.html']
                            }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(htmlContent);
                    await writable.close();
                    
                    return true;
                } catch (error) {
                    // U≈ºytkownik anulowa≈Ç dialog lub wystƒÖpi≈Ç b≈ÇƒÖd
                    if (error.name !== 'AbortError') {
                        console.error('B≈ÇƒÖd zapisu pliku:', error);
                        // Fallback do standardowego pobierania
                    } else {
                        return false; // U≈ºytkownik anulowa≈Ç
                    }
                }
            }
            
            // Fallback: standardowe pobieranie (u≈ºytkownik mo≈ºe wybraƒá lokalizacjƒô w dialogu przeglƒÖdarki)
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = finalFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            return true;
        }

        // Funkcja pomocnicza do czyszczenia kontener√≥w dynamicznych sekcji
        function clearContainer(containerId) {
            const container = document.getElementById(containerId);
            const sections = container.querySelectorAll('.dynamic-section');
            sections.forEach((section, index) => {
                if (index > 0) {
                    section.remove();
                } else {
                    // Wyczy≈õƒá pierwszy element zamiast usuwaƒá
                    const inputs = section.querySelectorAll('input, textarea');
                    inputs.forEach(input => input.value = '');
                }
            });
        }

        // Funkcja wysy≈Çania danych do AI
        async function sendToAI(cvData) {
            const responseDiv = document.getElementById('ai-response-content');
            const aiSection = document.getElementById('ai-response');
            
            // Poka≈º sekcjƒô AI
            aiSection.style.display = 'block';
            responseDiv.textContent = 'Przetwarzanie...';
            responseDiv.style.color = '';
            responseDiv.style.fontWeight = '';
            // Ukryj przyciski akcji podczas generowania
            document.getElementById('ai-response-actions').style.display = 'none';
            
            // Przewi≈Ñ do sekcji AI
            aiSection.scrollIntoView({ behavior: 'smooth' });

            try {
                // Pobierz provider i konfiguracjƒô z config.js
                const provider = window.config?.provider || 'gemini';
                // Pobierz wybrany motyw i prompt
                const selectedThemeKey = (document.getElementById('theme-select') || {}).value || window.config?.defaultTheme || 'modernBlue';
                const selectedPromptKey = (document.getElementById('prompt-select') || {}).value || window.config?.defaultPromptKey || 'verbose';
                
                // Pobierz template HTML na podstawie wybranego motywu
                const templateHtml = window.config?.getTemplateHtml ? window.config.getTemplateHtml(selectedThemeKey) : (window.config?.templateHtml || '');
                
                // Pobierz pe≈Çny prompt (wsp√≥lna czƒô≈õƒá + specyficzne instrukcje)
                let promptText = '';
                if (window.config?.getFullPrompt) {
                    promptText = window.config.getFullPrompt(selectedPromptKey);
                } else {
                    // Fallback dla kompatybilno≈õci wstecznej
                    const prompts = window.config?.prompts;
                    if (prompts && selectedPromptKey && prompts[selectedPromptKey]?.text) {
                        promptText = prompts[selectedPromptKey].text;
                    } else {
                        promptText = window.config?.cvPrompt || '';
                    }
                }
                
                console.log('Wysy≈Çanie do backend API:', {
                    provider: provider,
                    promptLength: promptText.length,
                    templateLength: templateHtml.length
                });
                
                // Wywo≈Çanie backend API (tokeny sƒÖ bezpieczne na serwerze!)
                const res = await fetch('/api/generate-cv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: provider,
                        prompt: promptText,
                        templateHtml: templateHtml,
                        cvData: cvData
                    })
                });

                if (!res.ok) {
                    let errorMessage = `B≈ÇƒÖd ${res.status}: ${res.statusText}`;
                    try {
                        const err = await res.json();
                        errorMessage = err.error || err.message || errorMessage;
                    } catch (e) {
                        // Je≈õli odpowied≈∫ nie jest JSON, u≈ºyj statusText
                    }
                    responseDiv.textContent = 'B≈ÇƒÖd API: ' + errorMessage;
                    responseDiv.style.color = '#dc3545';
                    return;
                }

                const data = await res.json();

                // Pobierz wygenerowany HTML z odpowiedzi backendu
                const cleanedHtml = data.html || '';

                if (!cleanedHtml) {
                    responseDiv.textContent = 'B≈ÇƒÖd: Backend nie zwr√≥ci≈Ç HTML';
                    responseDiv.style.color = '#dc3545';
                    return;
                }

                // Zapisz wygenerowany HTML w zmiennej globalnej
                generatedCVHtml = cleanedHtml;
                // Zwolnij poprzedni blob URL je≈õli istnieje
                if (generatedCVBlobUrl) {
                    URL.revokeObjectURL(generatedCVBlobUrl);
                }
                // Utw√≥rz nowy blob URL dla podglƒÖdu
                const blob = new Blob([cleanedHtml], { type: 'text/html;charset=utf-8' });
                generatedCVBlobUrl = URL.createObjectURL(blob);
                
                // Poka≈º przyciski akcji
                document.getElementById('ai-response-actions').style.display = 'flex';
                responseDiv.textContent = '‚úì CV zosta≈Ço wygenerowane pomy≈õlnie!';
                responseDiv.style.color = '#28a745';
                responseDiv.style.fontWeight = 'bold';
                
                // Automatycznie otw√≥rz CV w nowej karcie
                setTimeout(() => {
                    openGeneratedCV();
                }, 500);
                
            } catch (error) {
                console.error('B≈ÇƒÖd sieci:', error);
                responseDiv.textContent = 'B≈ÇƒÖd sieci: ' + error.message;
            }
        }
    </script>
</body>
</html>