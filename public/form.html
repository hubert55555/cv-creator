<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formularz CV - CV Creator</title>
    <script src="config.js"></script>
    <script src="header.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gradient-start: #667eea;
            --gradient-end: #764ba2;
            --text-dark: #212529;
            --text-light: #6c757d;
            --bg-light: #f8f9fa;
            --white: #ffffff;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --danger-color: #dc3545;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--bg-light) 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 0;
        }


        /* Form Container */
        .form-wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem 3rem 2rem;
        }

        .form-container {
            background: var(--white);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        input[type="text"], 
        input[type="email"], 
        input[type="tel"], 
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: var(--white);
        }

        input[type="text"]:focus, 
        input[type="email"]:focus, 
        input[type="tel"]:focus, 
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--gradient-start);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            height: 100px;
            resize: vertical;
            min-height: 100px;
        }

        .dynamic-section {
            border: 2px solid var(--border-color);
            padding: 1.25rem;
            margin: 1rem 0;
            border-radius: 12px;
            background: var(--bg-light);
            transition: all 0.3s ease;
        }

        .dynamic-section:hover {
            border-color: var(--gradient-start);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .add-btn, .remove-btn {
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .add-btn {
            background: var(--white);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .add-btn:hover {
            background: var(--bg-light);
            border-color: var(--gradient-start);
        }

        .remove-btn {
            background: var(--danger-color);
            color: var(--white);
        }

        .remove-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .section-title {
            color: var(--text-dark);
            border-bottom: 3px solid;
            border-image: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)) 1;
            padding-bottom: 0.5rem;
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .year-input {
            width: 100px;
            display: inline-block;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--white);
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            margin-top: 2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .info-box {
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid;
        }

        .info-box-yellow {
            background-color: #fff3cd;
            border-color: #ffc107;
        }

        .info-box-blue {
            background-color: #e7f3ff;
            border-color: #007bff;
        }

        .info-box-gray {
            background-color: #f9f9f9;
            border-color: #ddd;
        }

        .info-box p {
            margin: 0.75rem 0 0 0;
            font-size: 0.9rem;
            color: #856404;
        }

        .info-box-yellow p {
            color: #856404;
        }

        .info-box-blue p {
            color: #004085;
        }

        .info-box button {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .info-box-yellow button {
            background-color: #ffc107;
            color: #000;
        }

        .info-box-yellow button:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        .info-box-blue button {
            background-color: #007bff;
            color: white;
        }

        .info-box-blue button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        #ai-response {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #007bff;
            background-color: #e7f3ff;
        }

        #ai-response-content {
            background-color: var(--white);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        #ai-response-actions {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
        }

        #ai-response-actions button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #ai-response-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-wrapper {
                padding: 0 1rem 2rem 1rem;
            }

            .form-container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="form-wrapper">
        <div class="form-container">
            <h1>Formularz CV</h1>
            
            <!-- Sekcja ustawie≈Ñ generatora -->
            <div class="info-box info-box-gray">
                <h2 class="section-title" style="margin-top: 0;">Ustawienia generatora</h2>
                <div class="form-group">
                    <label for="theme-select">Motyw CV:</label>
                    <select id="theme-select">
                        <option value="">≈Åadowanie...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prompt-select">Tryb generowania:</label>
                    <select id="prompt-select">
                        <option value="">≈Åadowanie...</option>
                    </select>
                </div>
        </div>
        
            <!-- Sekcja importu/eksportu -->
            <div style="margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--border-color);">
                <p style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--text-light);">Zapisz lub wczytaj dane formularza:</p>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                    <button type="button" onclick="downloadJSON()" style="padding: 0.5rem 1rem; background: var(--white); color: var(--text-dark); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-light)'; this.style.borderColor='var(--gradient-start)'" onmouseout="this.style.background='var(--white)'; this.style.borderColor='var(--border-color)'">üíæ Zapisz (JSON)</button>
                    <label style="padding: 0.5rem 1rem; background: var(--white); color: var(--text-dark); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; display: inline-block; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-light)'; this.style.borderColor='var(--gradient-start)'" onmouseout="this.style.background='var(--white)'; this.style.borderColor='var(--border-color)'">
                        üìÅ Wczytaj (JSON)
                        <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadFromJSONFile(event)">
                    </label>
                </div>
            </div>
        
        <form id="cvForm">
            <!-- Podstawowe dane -->
            <h2 class="section-title">Dane osobowe</h2>
            
            <div class="form-group">
                <label for="imie">Imiƒô:</label>
                <input type="text" id="imie" name="imie">
            </div>
            
            <div class="form-group">
                <label for="nazwisko">Nazwisko:</label>
                <input type="text" id="nazwisko" name="nazwisko">
            </div>
            
            <div class="form-group">
                <label for="telefon">Numer telefonu:</label>
                <input type="tel" id="telefon" name="telefon">
            </div>
            
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email">
            </div>
            
            <div class="form-group">
                <label for="adres">Adres:</label>
                <input type="text" id="adres" name="adres">
            </div>
            
            <!-- O mnie -->
            <h2 class="section-title">O mnie</h2>
            <div class="form-group">
                <label for="o-mnie">Kr√≥tko o mnie:</label>
                <textarea id="o-mnie" name="o-mnie" placeholder="Napisz kilka zda≈Ñ o sobie..."></textarea>
            </div>
            
            <!-- Edukacja -->
            <h2 class="section-title">Edukacja</h2>
            <div id="szkoly-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Nazwa szko≈Çy:</label>
                        <input type="text" name="szkola[]">
                    </div>
                    <div class="form-group">
                        <label>Lata nauki:</label>
                        <input type="text" name="lata-szkola[]" placeholder="np. 2018-2022">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addSchool()">+ Dodaj szko≈Çƒô</button>
            
            <!-- Umiejƒôtno≈õci -->
            <h2 class="section-title">Umiejƒôtno≈õci</h2>
            <div id="umiejetnosci-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Umiejƒôtno≈õƒá:</label>
                        <input type="text" name="umiejetnosc[]" placeholder="np. JavaScript, Photoshop">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addSkill()">+ Dodaj umiejƒôtno≈õƒá</button>
            
            <!-- Jƒôzyki -->
            <h2 class="section-title">Jƒôzyki</h2>
            <div id="jezyki-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Jƒôzyk:</label>
                        <input type="text" name="jezyk[]" placeholder="np. Angielski">
                    </div>
                    <div class="form-group">
                        <label>Poziom:</label>
                        <input type="text" name="poziom-jezyk[]" placeholder="np. B2, Native">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addLanguage()">+ Dodaj jƒôzyk</button>
            
            <!-- Do≈õwiadczenie zawodowe -->
            <h2 class="section-title">Do≈õwiadczenie zawodowe</h2>
            <div id="doswiadczenie-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Stanowisko:</label>
                        <input type="text" name="stanowisko[]">
                    </div>
                    <div class="form-group">
                        <label>Firma:</label>
                        <input type="text" name="firma[]">
                    </div>
                    <div class="form-group">
                        <label>Lata pracy:</label>
                        <input type="text" name="lata-praca[]" placeholder="np. 2020-2023">
                    </div>
                    <div class="form-group">
                        <label>Opis obowiƒÖzk√≥w:</label>
                        <textarea name="obowiazki[]" placeholder="Opisz co robi≈Çe≈õ w tej pracy..."></textarea>
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addExperience()">+ Dodaj do≈õwiadczenie</button>
            
            <!-- Referencje/Projekty -->
            <h2 class="section-title">Referencje / Projekty osobiste</h2>
            <div id="referencje-container">
                <div class="dynamic-section">
                    <div class="form-group">
                        <label>Tytu≈Ç projektu/referencji:</label>
                        <input type="text" name="tytul-projektu[]">
                    </div>
                    <div class="form-group">
                        <label>Opis:</label>
                        <textarea name="opis-projektu[]" placeholder="Opisz projekt lub referencjƒô..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Link (opcjonalnie):</label>
                        <input type="text" name="link-projektu[]" placeholder="https://...">
                    </div>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addReference()">+ Dodaj referencjƒô/projekt</button>
            
            <button type="submit" class="submit-btn">Generuj CV</button>
        </form>
        
        
            <!-- Sekcja odpowiedzi AI -->
            <div id="ai-response" style="display: none;">
                <h3 style="margin-top: 0; margin-bottom: 1rem; font-weight: 700;">Wygenerowane CV:</h3>
                <div id="ai-response-content">
                    Przetwarzanie...
                </div>
                <div id="ai-response-actions" style="display: none;">
                    <button type="button" onclick="openGeneratedCV()">
                        üöÄ Otw√≥rz w nowej karcie
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicjalizacja headera
        if (window.CVCreatorHeader) {
            window.CVCreatorHeader.initHeader({
                logoHref: 'index.html',
                buttons: [
                    { label: 'üè† Strona g≈Ç√≥wna', shortLabel: 'üè†', href: 'index.html', type: 'secondary' },
                    { label: '‚úèÔ∏è Edytor', shortLabel: '‚úèÔ∏è', onclick: 'openEmptyEditor()', type: 'secondary' }
                ],
                fixed: true
            });
        }

        // Funkcje do dodawania dynamicznych sekcji
        function addSchool() {
            const container = document.getElementById('szkoly-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Nazwa szko≈Çy:</label>
                    <input type="text" name="szkola[]">
                </div>
                <div class="form-group">
                    <label>Lata nauki:</label>
                    <input type="text" name="lata-szkola[]" placeholder="np. 2018-2022">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addSkill() {
            const container = document.getElementById('umiejetnosci-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Umiejƒôtno≈õƒá:</label>
                    <input type="text" name="umiejetnosc[]" placeholder="np. JavaScript, Photoshop">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addLanguage() {
            const container = document.getElementById('jezyki-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Jƒôzyk:</label>
                    <input type="text" name="jezyk[]" placeholder="np. Angielski">
                </div>
                <div class="form-group">
                    <label>Poziom:</label>
                    <input type="text" name="poziom-jezyk[]" placeholder="np. B2, Native">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addExperience() {
            const container = document.getElementById('doswiadczenie-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Stanowisko:</label>
                    <input type="text" name="stanowisko[]">
                </div>
                <div class="form-group">
                    <label>Firma:</label>
                    <input type="text" name="firma[]">
                </div>
                <div class="form-group">
                    <label>Lata pracy:</label>
                    <input type="text" name="lata-praca[]" placeholder="np. 2020-2023">
                </div>
                <div class="form-group">
                    <label>Opis obowiƒÖzk√≥w:</label>
                    <textarea name="obowiazki[]" placeholder="Opisz co robi≈Çe≈õ w tej pracy..."></textarea>
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function addReference() {
            const container = document.getElementById('referencje-container');
            const newSection = document.createElement('div');
            newSection.className = 'dynamic-section';
            newSection.innerHTML = `
                <div class="form-group">
                    <label>Tytu≈Ç projektu/referencji:</label>
                    <input type="text" name="tytul-projektu[]">
                </div>
                <div class="form-group">
                    <label>Opis:</label>
                    <textarea name="opis-projektu[]" placeholder="Opisz projekt lub referencjƒô..."></textarea>
                </div>
                <div class="form-group">
                    <label>Link (opcjonalnie):</label>
                    <input type="text" name="link-projektu[]" placeholder="https://...">
                </div>
                <button type="button" class="remove-btn" onclick="removeSection(this)">Usu≈Ñ</button>
            `;
            container.appendChild(newSection);
        }

        function removeSection(button) {
            button.parentElement.remove();
        }

        // Funkcja zbierajƒÖca dane w formacie JSON
        function collectFormData() {
            const formData = {
                daneOsobowe: {
                    imie: document.getElementById('imie').value,
                    nazwisko: document.getElementById('nazwisko').value,
                    telefon: document.getElementById('telefon').value,
                    email: document.getElementById('email').value,
                    adres: document.getElementById('adres').value
                },
                oMnie: document.getElementById('o-mnie').value,
                edukacja: [],
                umiejetnosci: [],
                jezyki: [],
                doswiadczenie: [],
                referencje: []
            };

            // Zbieranie danych z edukacji
            const szkoly = document.querySelectorAll('input[name="szkola[]"]');
            const lataSzkola = document.querySelectorAll('input[name="lata-szkola[]"]');
            for (let i = 0; i < szkoly.length; i++) {
                if (szkoly[i].value.trim() || lataSzkola[i].value.trim()) {
                    formData.edukacja.push({
                        szkola: szkoly[i].value,
                        lata: lataSzkola[i].value
                    });
                }
            }

            // Zbieranie umiejƒôtno≈õci
            const umiejetnosci = document.querySelectorAll('input[name="umiejetnosc[]"]');
            umiejetnosci.forEach(input => {
                if (input.value.trim()) {
                    formData.umiejetnosci.push(input.value);
                }
            });

            // Zbieranie jƒôzyk√≥w
            const jezyki = document.querySelectorAll('input[name="jezyk[]"]');
            const poziomy = document.querySelectorAll('input[name="poziom-jezyk[]"]');
            for (let i = 0; i < jezyki.length; i++) {
                if (jezyki[i].value.trim() || poziomy[i].value.trim()) {
                    formData.jezyki.push({
                        jezyk: jezyki[i].value,
                        poziom: poziomy[i].value
                    });
                }
            }

            // Zbieranie do≈õwiadczenia
            const stanowiska = document.querySelectorAll('input[name="stanowisko[]"]');
            const firmy = document.querySelectorAll('input[name="firma[]"]');
            const lataPraca = document.querySelectorAll('input[name="lata-praca[]"]');
            const obowiazki = document.querySelectorAll('textarea[name="obowiazki[]"]');
            for (let i = 0; i < stanowiska.length; i++) {
                if (stanowiska[i].value.trim() || firmy[i].value.trim() || lataPraca[i].value.trim()) {
                    formData.doswiadczenie.push({
                        stanowisko: stanowiska[i].value,
                        firma: firmy[i].value,
                        lata: lataPraca[i].value,
                        obowiazki: obowiazki[i].value
                    });
                }
            }

            // Zbieranie referencji/projekt√≥w
            const tytuly = document.querySelectorAll('input[name="tytul-projektu[]"]');
            const opisy = document.querySelectorAll('textarea[name="opis-projektu[]"]');
            const linki = document.querySelectorAll('input[name="link-projektu[]"]');
            for (let i = 0; i < tytuly.length; i++) {
                if (tytuly[i].value.trim() || opisy[i].value.trim()) {
                    formData.referencje.push({
                        tytul: tytuly[i].value,
                        opis: opisy[i].value,
                        link: linki[i].value
                    });
                }
            }

            return formData;
        }

        // Obs≈Çuga formularza
        document.getElementById('cvForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Zbieranie danych w formacie JSON
            const cvData = collectFormData();
            
            // Wy≈õwietlenie danych w konsoli (do debugowania)
            console.log('Dane CV w formacie JSON:', cvData);
            
            // Przekazanie danych do zmiennej globalnej
            window.cvData = cvData;
            
            // Automatyczne wys≈Çanie danych do AI
            sendToAI(cvData);
        });

        // Funkcja inicjalizacji selektora motyw√≥w
        function initThemeSelector() {
            const select = document.getElementById('theme-select');
            if (!select) {
                // Spr√≥buj ponownie za chwilƒô, je≈õli element jeszcze nie istnieje
                setTimeout(initThemeSelector, 100);
                return;
            }

            const templates = window.config?.templates;
            
            // Je≈õli config jeszcze nie jest za≈Çadowany, spr√≥buj ponownie
            if (!window.config || !templates) {
                setTimeout(initThemeSelector, 100);
                return;
            }

            // Wyczyszczenie opcji
            select.innerHTML = '';

            if (templates && typeof templates === 'object') {
                // Mapowanie kluczy motyw√≥w na czytelne nazwy
                const themeLabels = {
                    modernBlue: 'Modern Blue',
                    classic: 'Classic'
                };
                
                // Dodaj opcje z config.templates
                Object.keys(templates).forEach((key) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = themeLabels[key] || key;
                    select.appendChild(opt);
                });
                // Domy≈õlnie wybierz 'modernBlue' je≈õli istnieje
                if (templates.modernBlue) {
                    select.value = 'modernBlue';
                }
            } else {
                // Fallback
                const opt = document.createElement('option');
                opt.value = 'modernBlue';
                opt.textContent = 'Modern Blue';
                select.appendChild(opt);
            }
        }

        // Funkcja inicjalizacji selektora prompt√≥w
        function initPromptSelector() {
            const select = document.getElementById('prompt-select');
            if (!select) {
                // Spr√≥buj ponownie za chwilƒô, je≈õli element jeszcze nie istnieje
                setTimeout(initPromptSelector, 100);
                return;
            }

            const prompts = window.config?.prompts;
            
            // Je≈õli config jeszcze nie jest za≈Çadowany, spr√≥buj ponownie
            if (!window.config || !prompts) {
                setTimeout(initPromptSelector, 100);
                return;
            }

            // Wyczyszczenie opcji
            select.innerHTML = '';

            if (prompts && typeof prompts === 'object') {
                // Dodaj opcje z config.prompts
                Object.keys(prompts).forEach((key) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = prompts[key]?.label || key;
                    select.appendChild(opt);
                });
                // Domy≈õlnie wybierz 'verbose' je≈õli istnieje, w innym razie pierwszƒÖ opcjƒô
                if (prompts.verbose) {
                    select.value = 'verbose';
                }
            } else {
                // Fallback do pojedynczego cvPrompt
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Domy≈õlny prompt';
                select.appendChild(opt);
            }
        }

        // Uruchom inicjalizacjƒô po za≈Çadowaniu DOM i config.js
        function initializeSelectors() {
            let attempts = 0;
            const maxAttempts = 50; // Maksymalnie 5 sekund (50 * 100ms)
            
            function tryInit() {
                attempts++;
                if (window.config && window.config.templates && window.config.prompts) {
                    // Config jest gotowy
                    initThemeSelector();
                    initPromptSelector();
                } else if (attempts < maxAttempts) {
                    // Spr√≥buj ponownie za 100ms
                    setTimeout(tryInit, 100);
                } else {
                    // Po max pr√≥bach, u≈ºyj fallback
                    console.warn('Config.js nie zosta≈Ç za≈Çadowany w oczekiwanym czasie. U≈ºywam fallback.');
                    const themeSelect = document.getElementById('theme-select');
                    const promptSelect = document.getElementById('prompt-select');
                    if (themeSelect) {
                        themeSelect.innerHTML = '<option value="modernBlue">Modern Blue</option>';
                    }
                    if (promptSelect) {
                        promptSelect.innerHTML = '<option value="verbose">Kreatywne rozwiniƒôcie</option>';
                    }
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', tryInit);
            } else {
                tryInit();
            }
        }
        
        // Uruchom inicjalizacjƒô
        initializeSelectors();

        // Funkcja pobierania JSON jako plik
        function downloadJSON() {
            const cvData = collectFormData();
            const jsonText = JSON.stringify(cvData, null, 2);
            const blob = new Blob([jsonText], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cv_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Funkcja kopiowania JSON do schowka
        function copyToClipboard() {
            const cvData = collectFormData();
            const jsonText = JSON.stringify(cvData, null, 2);
            navigator.clipboard.writeText(jsonText).then(function() {
                alert('JSON zosta≈Ç skopiowany do schowka!');
            }).catch(function(err) {
                console.error('B≈ÇƒÖd kopiowania: ', err);
                // Fallback dla starszych przeglƒÖdarek
                const textArea = document.createElement('textarea');
                textArea.value = jsonText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('JSON zosta≈Ç skopiowany do schowka!');
            });
        }

        // Funkcja wczytujƒÖca dane z pliku JSON i wype≈ÇniajƒÖca formularz
        function loadFromJSONFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    populateFormFromJSON(jsonData);
                    
                    // Wyczy≈õƒá input, ≈ºeby mo≈ºna by≈Ço wczytaƒá ten sam plik ponownie
                    event.target.value = '';
                } catch (error) {
                    alert('B≈ÇƒÖd: Nieprawid≈Çowy format JSON. ' + error.message);
                    console.error('B≈ÇƒÖd parsowania JSON:', error);
                }
            };
            reader.onerror = function() {
                alert('B≈ÇƒÖd podczas odczytu pliku.');
            };
            reader.readAsText(file);
        }

        // Funkcja wype≈ÇniajƒÖca formularz danymi z JSON
        function populateFormFromJSON(data) {
            // Wype≈Çnij dane osobowe
            if (data.daneOsobowe) {
                if (data.daneOsobowe.imie) document.getElementById('imie').value = data.daneOsobowe.imie;
                if (data.daneOsobowe.nazwisko) document.getElementById('nazwisko').value = data.daneOsobowe.nazwisko;
                if (data.daneOsobowe.telefon) document.getElementById('telefon').value = data.daneOsobowe.telefon;
                if (data.daneOsobowe.email) document.getElementById('email').value = data.daneOsobowe.email;
                if (data.daneOsobowe.adres) document.getElementById('adres').value = data.daneOsobowe.adres;
            }

            // Wype≈Çnij "O mnie"
            if (data.oMnie) document.getElementById('o-mnie').value = data.oMnie;

            // Wype≈Çnij edukacjƒô
            if (data.edukacja && Array.isArray(data.edukacja) && data.edukacja.length > 0) {
                clearContainer('szkoly-container');
                data.edukacja.forEach((ed, index) => {
                    if (index > 0) addSchool();
                    const sections = document.querySelectorAll('#szkoly-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    if (inputs[0]) inputs[0].value = ed.szkola || '';
                    if (inputs[1]) inputs[1].value = ed.lata || '';
                });
            }

            // Wype≈Çnij umiejƒôtno≈õci
            if (data.umiejetnosci && Array.isArray(data.umiejetnosci) && data.umiejetnosci.length > 0) {
                clearContainer('umiejetnosci-container');
                data.umiejetnosci.forEach((skill, index) => {
                    if (index > 0) addSkill();
                    const sections = document.querySelectorAll('#umiejetnosci-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    if (inputs[0]) inputs[0].value = skill || '';
                });
            }

            // Wype≈Çnij jƒôzyki
            if (data.jezyki && Array.isArray(data.jezyki) && data.jezyki.length > 0) {
                clearContainer('jezyki-container');
                data.jezyki.forEach((lang, index) => {
                    if (index > 0) addLanguage();
                    const sections = document.querySelectorAll('#jezyki-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    if (inputs[0]) inputs[0].value = lang.jezyk || '';
                    if (inputs[1]) inputs[1].value = lang.poziom || '';
                });
            }

            // Wype≈Çnij do≈õwiadczenie
            if (data.doswiadczenie && Array.isArray(data.doswiadczenie) && data.doswiadczenie.length > 0) {
                clearContainer('doswiadczenie-container');
                data.doswiadczenie.forEach((exp, index) => {
                    if (index > 0) addExperience();
                    const sections = document.querySelectorAll('#doswiadczenie-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    const textareas = sections[index].querySelectorAll('textarea');
                    if (inputs[0]) inputs[0].value = exp.stanowisko || '';
                    if (inputs[1]) inputs[1].value = exp.firma || '';
                    if (inputs[2]) inputs[2].value = exp.lata || '';
                    if (textareas[0]) textareas[0].value = exp.obowiazki || '';
                });
            }

            // Wype≈Çnij referencje/projekty
            if (data.referencje && Array.isArray(data.referencje) && data.referencje.length > 0) {
                clearContainer('referencje-container');
                data.referencje.forEach((ref, index) => {
                    if (index > 0) addReference();
                    const sections = document.querySelectorAll('#referencje-container .dynamic-section');
                    const inputs = sections[index].querySelectorAll('input');
                    const textareas = sections[index].querySelectorAll('textarea');
                    if (inputs[0]) inputs[0].value = ref.tytul || '';
                    if (textareas[0]) textareas[0].value = ref.opis || '';
                    if (inputs[1]) inputs[1].value = ref.link || '';
                });
            }
        }

        // Zmienna globalna do przechowywania wygenerowanego HTML
        let generatedCVHtml = null;
        let generatedCVBlobUrl = null;

        // Zawarto≈õƒá plik√≥w CSS i JS (do wbudowania w HTML) - cv-scaling.css jako fallback
        const cvScalingCssFallback = `/* Wsp√≥lne style skalowania CV dla wszystkich motyw√≥w */
/* Ten plik zawiera regu≈Çy odpowiedzialne za automatyczne dopasowanie CV do jednej strony A4 */
/* Nale≈ºy za≈Çadowaƒá ten plik PRZED plikiem CSS motywu (style.css lub style1.css) */

:root {
  /* Skalowanie zawarto≈õci (ustawiane przez cv-auto-fit.js) */
  --content-scale: 1;
}

/* Pojedyncza strona A4 - ustawienia skalowania */
/* Uwaga: --page-height jest definiowane w pliku CSS motywu (style.css/style1.css) */
.page {
  height: var(--page-height, 297mm); /* Fallback do 297mm je≈õli zmienna nie jest zdefiniowana */
  overflow: hidden; /* Ukryj wszystko co wychodzi poza stronƒô */
  position: relative;
}

/* Struktura zawarto≈õci CV - przygotowanie do skalowania */
.cv-columns {
  transform-origin: top left; /* Dla skalowania z cv-auto-fit.js */
}

/* Ustawienia druku z zachowaniem skalowania */
@media print {
  .page {
    height: var(--page-height, 297mm) !important; /* Dok≈Çadna wysoko≈õƒá A4 */
    overflow: hidden !important; /* Ukryj wszystko co wychodzi poza stronƒô przy druku */
  }
  /* Transform scale dzia≈Ça przy druku, wiƒôc skalowanie bƒôdzie dzia≈Çaƒá */
}
`;

        // Funkcja wbudowujƒÖca CSS i JS bezpo≈õrednio w HTML
        async function embedAssetsInHtml(htmlString) {
            let processedHtml = htmlString;
            
            // Pobierz zawarto≈õƒá plik√≥w CSS i JS u≈ºywajƒÖc fetch
            const assets = {
                'cv-scaling.css': cvScalingCssFallback,
                'cv-auto-fit.js': '',
                'cv-inline-edit.js': '',
                'header.js': '',
            };

            // Spr√≥buj wczytaƒá pliki CSS z serwera
            try {
                const cvScalingResponse = await fetch('cv-scaling.css');
                if (cvScalingResponse.ok) {
                    assets['cv-scaling.css'] = await cvScalingResponse.text();
                }
            } catch (e) {
                // U≈ºyj fallback
            }

            try {
                const styleResponse = await fetch('style.css');
                if (styleResponse.ok) {
                    assets['style.css'] = await styleResponse.text();
                }
            } catch (e) {
                // U≈ºyj pustej zawarto≈õci
            }

            try {
                const style1Response = await fetch('style1.css');
                if (style1Response.ok) {
                    assets['style1.css'] = await style1Response.text();
                }
            } catch (e) {
                // U≈ºyj pustej zawarto≈õci
            }

            // Spr√≥buj wczytaƒá pliki JS z serwera
            try {
                const autoFitResponse = await fetch('cv-auto-fit.js');
                if (autoFitResponse.ok) {
                    assets['cv-auto-fit.js'] = await autoFitResponse.text();
                }
            } catch (e) {
                console.warn('Nie mo≈ºna wczytaƒá cv-auto-fit.js');
            }

            try {
                const inlineEditResponse = await fetch('cv-inline-edit.js');
                if (inlineEditResponse.ok) {
                    assets['cv-inline-edit.js'] = await inlineEditResponse.text();
                }
            } catch (e) {
                console.warn('Nie mo≈ºna wczytaƒá cv-inline-edit.js');
            }

            try {
                const headerResponse = await fetch('header.js');
                if (headerResponse.ok) {
                    assets['header.js'] = await headerResponse.text();
                }
            } catch (e) {
                console.warn('Nie mo≈ºna wczytaƒá header.js');
            }

            // Zamie≈Ñ linki do CSS na inline style
            const linkCssRegex = /<link\s+rel="stylesheet"\s+href="([^"]+\.css)"\s*\/?>/gi;
            processedHtml = processedHtml.replace(
                linkCssRegex,
                (match, href) => {
                    const filename = href.split('/').pop();
                    if (assets[filename]) {
                        // Escape specjalnych znak√≥w w CSS
                        const escapedCss = assets[filename].replace(/<\/style>/gi, '<\\/style>');
                        return '<style>' + escapedCss + '</style>';
                    }
                    return match; // Je≈õli plik nie zosta≈Ç znaleziony, pozostaw oryginalny link
                }
            );

            // Zamie≈Ñ skrypty JS na inline script
            // U≈ºyj split aby uniknƒÖƒá ko≈Ñca tagu script w kodzie ≈∫r√≥d≈Çowym HTML
            const scriptOpen = '<' + 'script';
            const scriptClose = '<' + '/' + 'script' + '>';
            const scriptEndRegexPattern = '<' + '\\/' + 'script' + '>';
            const scriptEndRegex = new RegExp(scriptEndRegexPattern, 'gi');
            
            // Buduj regex pattern dla script src
            const scriptSrcPattern = scriptOpen + '\\s+src="([^"]+\\.js)"\\s*' + '>' + scriptClose;
            const scriptSrcRegex = new RegExp(scriptSrcPattern, 'gi');
            
            processedHtml = processedHtml.replace(scriptSrcRegex, function(match, src) {
                const filename = src.split('/').pop();
                if (assets[filename]) {
                    // Escape specjalnych znak√≥w w JS
                    const escapedJs = assets[filename].replace(scriptEndRegex, '<\\/script>');
                    return scriptOpen + '>' + escapedJs + scriptClose;
                }
                return match;
            });

            return processedHtml;
        }

        // Funkcja otwierajƒÖca pusty edytor CV (bez generowania)
        async function openEmptyEditor() {
            // Spr√≥buj wczytaƒá szablon z template1.html, je≈õli siƒô nie uda, u≈ºyj pustego szablonu
            let emptyCVTemplate = '';
            
            try {
                const response = await fetch('template1.html');
                if (response.ok) {
                    emptyCVTemplate = await response.text();
                    // Dodaj linki do skrypt√≥w edycji je≈õli ich nie ma
                    if (!emptyCVTemplate.includes('cv-auto-fit.js')) {
                        // Dodaj przed </body>
                        const scriptsToAdd = '<link rel="stylesheet" href="cv-scaling.css" />' +
                            '<script src="header.js"><' + '/script>' +
                            '<script src="cv-auto-fit.js"><' + '/script>' +
                            '<script src="cv-inline-edit.js"><' + '/script>';
                        emptyCVTemplate = emptyCVTemplate.replace('</body>', scriptsToAdd + '</body>');
                    }
                } else {
                    throw new Error('Nie mo≈ºna wczytaƒá szablonu');
                }
            } catch (e) {
                // Fallback - u≈ºyj podstawowego szablonu CV z minimalnƒÖ strukturƒÖ
                const parts = [
                    '<!doctype html><html lang="pl"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />',
                    '<title>CV ‚Äì Edytor</title><link rel="stylesheet" href="style.css" /><link rel="stylesheet" href="cv-scaling.css" /></head>',
                    '<body><section class="page"><div class="cv-columns"><aside class="cv-sidebar">',
                    '<div class="avatar"><img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=400&auto=format&fit=crop" alt="Zdjƒôcie profilowe" /></div>',
                    '<section class="side-section"><h3 class="side-title">Contact</h3><div class="side-list"><div>Telefon</div><div>Email</div><div>Adres</div></div></section>',
                    '<section class="side-section"><h3 class="side-title">Education</h3><div class="side-list"><div><strong>Lata</strong><br />Nazwa szko≈Çy<br />Kierunek</div></div></section>',
                    '<section class="side-section"><h3 class="side-title">Skills</h3><div class="side-list"><div>Umiejƒôtno≈õƒá 1</div><div>Umiejƒôtno≈õƒá 2</div></div></section>',
                    '<section class="side-section"><h3 class="side-title">Languages</h3><div class="side-list"><div>Jƒôzyk (Poziom)</div></div></section></aside>',
                    '<main class="cv-main"><header class="name-title"><h1><span class="light">IMIƒò</span> NAZWISKO</h1>',
                    '<div class="role">STANOWISKO</div><div class="underline"></div></header>',
                    '<section class="section"><div class="title">Profile</div><div class="rule"></div><p class="text">Opis profilu zawodowego...</p></section>',
                    '<section class="section"><div class="title">Work Experience</div><div class="rule"></div>',
                    '<div class="timeline"><article class="timeline-item"><div class="meta"><div><strong>Nazwa firmy</strong><br />Stanowisko</div><div>Lata</div></div>',
                    '<ul><li>Opis obowiƒÖzk√≥w 1</li><li>Opis obowiƒÖzk√≥w 2</li></ul></article></div></section>',
                    '<section class="section"><div class="title">Reference</div><div class="rule"></div>',
                    '<div class="references"><div class="ref-card"><div class="name">Nazwa projektu</div><div class="small">Opis projektu</div></div></div></section>',
                    '</main></div></section>' +
                    '<script src="header.js"><' + '/script>' +
                    '<script src="cv-auto-fit.js"><' + '/script>' +
                    '<script src="cv-inline-edit.js"><' + '/script>' +
                    '</body></html>'
                ];
                emptyCVTemplate = parts.join('');
            }
            
            // Wbuduj CSS i JS w HTML przed utworzeniem blob URL
            const htmlWithAssets = await embedAssetsInHtml(emptyCVTemplate);
            
            // Utw√≥rz blob URL z HTML zawierajƒÖcym wbudowane zasoby
            const blob = new Blob([htmlWithAssets], { type: 'text/html;charset=utf-8' });
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        }

        // Funkcja dodajƒÖca header do wygenerowanego CV
        function addHeaderToGeneratedCV(htmlString) {
            // U≈ºyj wsp√≥lnej funkcji z header.js je≈õli dostƒôpna
            if (window.CVCreatorHeader && window.CVCreatorHeader.injectHeaderIntoHTML) {
                return window.CVCreatorHeader.injectHeaderIntoHTML(htmlString, {
                    logoHref: 'index.html',
                    buttons: [
                        { 
                            label: 'üñ®Ô∏è Drukuj',
                            shortLabel: 'üñ®Ô∏è',
                            onclick: 'if(window.printCV) { window.printCV(); } else { window.print(); }', 
                            type: 'primary' 
                        },
                        { 
                            label: 'üíæ Zapisz stan CV',
                            shortLabel: 'üíæ',
                            onclick: 'if(window.cvInit){window.cvInit();} var saveName = prompt("Wprowad≈∫ nazwƒô dla tego zapisu (lub zostaw puste dla automatycznej):", ""); if (saveName !== null && window.saveCVState) { window.saveCVState(saveName || null); }', 
                            type: 'secondary',
                            id: 'cv-download-btn'
                        },
                        { 
                            label: 'üìö Moje zapisy',
                            shortLabel: 'üìö',
                            onclick: 'if(window.cvInit){window.cvInit();} if(window.toggleSavesPanel){ window.toggleSavesPanel(); }', 
                            type: 'secondary',
                            id: 'cv-saves-manager-btn'
                        }
                    ],
                    fixed: true
                });
            }
            
            // Fallback je≈õli header.js nie jest dostƒôpny
            return htmlString;
        }

        // Funkcja otwierajƒÖca wygenerowane CV w nowej karcie
        async function openGeneratedCV() {
            if (!generatedCVHtml) {
                alert('Brak wygenerowanego CV. Najpierw wygeneruj CV.');
                return;
            }
            
            // Dodaj header do wygenerowanego CV
            let htmlWithHeader = addHeaderToGeneratedCV(generatedCVHtml);
            
            // Wbuduj CSS i JS w HTML przed utworzeniem blob URL
            const htmlWithAssets = await embedAssetsInHtml(htmlWithHeader);
            
            // Zwolnij poprzedni blob URL je≈õli istnieje
            if (generatedCVBlobUrl) {
                URL.revokeObjectURL(generatedCVBlobUrl);
            }
            
            // Utw√≥rz nowy blob URL z HTML zawierajƒÖcym wbudowane zasoby
            const blob = new Blob([htmlWithAssets], { type: 'text/html;charset=utf-8' });
            generatedCVBlobUrl = URL.createObjectURL(blob);
            window.open(generatedCVBlobUrl, '_blank');
        }

        // Funkcja zapisywania pliku HTML z mo≈ºliwo≈õciƒÖ wyboru nazwy i lokalizacji (u≈ºywana wewnƒôtrznie)
        async function saveHtmlFile(htmlContent, defaultFileName = 'cv.html') {
            // Zapytaj u≈ºytkownika o nazwƒô pliku
            const fileName = prompt('Wprowad≈∫ nazwƒô pliku:', defaultFileName.replace('.html', ''));
            
            if (!fileName) {
                // U≈ºytkownik anulowa≈Ç
                return false;
            }
            
            // Upewnij siƒô, ≈ºe plik ma rozszerzenie .html
            const finalFileName = fileName.endsWith('.html') ? fileName : fileName + '.html';
            
            // Pr√≥ba u≈ºycia File System Access API (daje mo≈ºliwo≈õƒá wyboru lokalizacji)
            if ('showSaveFilePicker' in window) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: finalFileName,
                        types: [{
                            description: 'HTML files',
                            accept: {
                                'text/html': ['.html']
                            }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(htmlContent);
                    await writable.close();
                    
                    return true;
                } catch (error) {
                    // U≈ºytkownik anulowa≈Ç dialog lub wystƒÖpi≈Ç b≈ÇƒÖd
                    if (error.name !== 'AbortError') {
                        console.error('B≈ÇƒÖd zapisu pliku:', error);
                        // Fallback do standardowego pobierania
                    } else {
                        return false; // U≈ºytkownik anulowa≈Ç
                    }
                }
            }
            
            // Fallback: standardowe pobieranie (u≈ºytkownik mo≈ºe wybraƒá lokalizacjƒô w dialogu przeglƒÖdarki)
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = finalFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            return true;
        }

        // Funkcja pomocnicza do czyszczenia kontener√≥w dynamicznych sekcji
        function clearContainer(containerId) {
            const container = document.getElementById(containerId);
            const sections = container.querySelectorAll('.dynamic-section');
            sections.forEach((section, index) => {
                if (index > 0) {
                    section.remove();
                } else {
                    // Wyczy≈õƒá pierwszy element zamiast usuwaƒá
                    const inputs = section.querySelectorAll('input, textarea');
                    inputs.forEach(input => input.value = '');
                }
            });
        }

        // Funkcja wysy≈Çania danych do AI
        async function sendToAI(cvData) {
            const responseDiv = document.getElementById('ai-response-content');
            const aiSection = document.getElementById('ai-response');
            
            // Poka≈º sekcjƒô AI
            aiSection.style.display = 'block';
            responseDiv.textContent = 'Przetwarzanie...';
            responseDiv.style.color = '';
            responseDiv.style.fontWeight = '';
            // Ukryj przyciski akcji podczas generowania
            document.getElementById('ai-response-actions').style.display = 'none';
            
            // Przewi≈Ñ do sekcji AI
            aiSection.scrollIntoView({ behavior: 'smooth' });

            try {
                // Pobierz provider i konfiguracjƒô z config.js
                const provider = window.config?.provider || 'gemini';
                // Pobierz wybrany motyw i prompt
                const selectedThemeKey = (document.getElementById('theme-select') || {}).value || window.config?.defaultTheme || 'modernBlue';
                const selectedPromptKey = (document.getElementById('prompt-select') || {}).value || window.config?.defaultPromptKey || 'verbose';
                
                // Pobierz template HTML na podstawie wybranego motywu
                const templateHtml = window.config?.getTemplateHtml ? window.config.getTemplateHtml(selectedThemeKey) : (window.config?.templateHtml || '');
                
                // Pobierz pe≈Çny prompt (wsp√≥lna czƒô≈õƒá + specyficzne instrukcje)
                let promptText = '';
                if (window.config?.getFullPrompt) {
                    promptText = window.config.getFullPrompt(selectedPromptKey);
                } else {
                    // Fallback dla kompatybilno≈õci wstecznej
                    const prompts = window.config?.prompts;
                    if (prompts && selectedPromptKey && prompts[selectedPromptKey]?.text) {
                        promptText = prompts[selectedPromptKey].text;
                    } else {
                        promptText = window.config?.cvPrompt || '';
                    }
                }
                
                console.log('Wysy≈Çanie do backend API:', {
                    provider: provider,
                    promptLength: promptText.length,
                    templateLength: templateHtml.length
                });
                
                // Wywo≈Çanie backend API (tokeny sƒÖ bezpieczne na serwerze!)
                const res = await fetch('/api/generate-cv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: provider,
                        prompt: promptText,
                        templateHtml: templateHtml,
                        cvData: cvData
                    })
                });

                if (!res.ok) {
                    let errorMessage = `B≈ÇƒÖd ${res.status}: ${res.statusText}`;
                    try {
                        const err = await res.json();
                        errorMessage = err.error || err.message || errorMessage;
                    } catch (e) {
                        // Je≈õli odpowied≈∫ nie jest JSON, u≈ºyj statusText
                    }
                    responseDiv.textContent = 'B≈ÇƒÖd API: ' + errorMessage;
                    responseDiv.style.color = '#dc3545';
                    return;
                }

                const data = await res.json();

                // Pobierz wygenerowany HTML z odpowiedzi backendu
                const cleanedHtml = data.html || '';

                if (!cleanedHtml) {
                    responseDiv.textContent = 'B≈ÇƒÖd: Backend nie zwr√≥ci≈Ç HTML';
                    responseDiv.style.color = '#dc3545';
                    return;
                }

                // Zapisz wygenerowany HTML w zmiennej globalnej
                generatedCVHtml = cleanedHtml;
                // Zwolnij poprzedni blob URL je≈õli istnieje
                if (generatedCVBlobUrl) {
                    URL.revokeObjectURL(generatedCVBlobUrl);
                }
                // Utw√≥rz nowy blob URL dla podglƒÖdu
                const blob = new Blob([cleanedHtml], { type: 'text/html;charset=utf-8' });
                generatedCVBlobUrl = URL.createObjectURL(blob);
                
                // Poka≈º przyciski akcji
                document.getElementById('ai-response-actions').style.display = 'flex';
                responseDiv.textContent = '‚úì CV zosta≈Ço wygenerowane pomy≈õlnie!';
                responseDiv.style.color = '#28a745';
                responseDiv.style.fontWeight = 'bold';
                
                // Automatycznie otw√≥rz CV w nowej karcie
                setTimeout(() => {
                    openGeneratedCV();
                }, 500);
                
            } catch (error) {
                console.error('B≈ÇƒÖd sieci:', error);
                responseDiv.textContent = 'B≈ÇƒÖd sieci: ' + error.message;
            }
        }
    </script>
</body>
</html>